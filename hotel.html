<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistente Marriott · Chat</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --muted:#94a3b8; --primary:#3b82f6; --ok:#22c55e; --err:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; background:linear-gradient(180deg, #0b1020, #0b1020 40%, #0e1630); color:#e5e7eb; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; min-height: 100dvh; display:flex; flex-direction:column; gap:12px; }
    header { padding: 8px 4px 0; display:flex; align-items:center; gap:10px; }
    header .dot { width:10px; height:10px; border-radius:50%; background:var(--ok); box-shadow:0 0 12px var(--ok); }
    header h1 { margin:0; font-size:18px; }
    header p { margin:0; color:var(--muted); font-size:13px; }
    .chat { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-radius:16px; padding:14px; flex:1; min-height: 55vh; overflow:auto; scroll-behavior:smooth; }
    .msg { display:flex; gap:10px; margin:10px 0; }
    .msg .avatar { width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; }
    .bot .avatar { background:#1f2a4a; color:#93c5fd; }
    .user .avatar { background:#153a24; color:#86efac; }
    .msg .bubble { max-width: 75%; padding:12px 14px; border-radius:14px; white-space:pre-wrap; word-wrap:anywhere; }
    .bot .bubble { background:#0f172a; border:1px solid rgba(148,163,184,.25); }
    .user .bubble { background:#0b2a16; border:1px solid rgba(34,197,94,.25); }
    .time { display:block; margin-top:6px; color:var(--muted); font-size:12px; }
    .input { display:flex; gap:10px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-radius:14px; padding:10px; }
    .input textarea { resize:none; height:52px; max-height:160px; flex:1; border:0; background:transparent; color:#e5e7eb; outline:none; font:16px/1.4 system-ui; }
    .input button { border:0; padding:0 16px; border-radius:10px; background:var(--primary); color:white; font-weight:600; cursor:pointer; }
    .input button:disabled { opacity:.6; cursor:not-allowed; }
    .status { color:var(--muted); font-size:13px; padding:0 2px; }
    .kbd { font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1226; border:1px solid rgba(255,255,255,.08); padding:2px 6px; border-radius:6px; color:#cbd5e1; }
    @media (max-width: 640px) {
      .msg .bubble { max-width: 82%; }
      .wrap { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <div>
        <h1>Asistente de Check-in – Hotel Marriott (Demo)</h1>
        <p>Escribe tu pregunta. Consejo: <span class="kbd">Enter</span> para enviar, <span class="kbd">Shift+Enter</span> para salto de línea.</p>
      </div>
    </header>

    <section id="chat" class="chat" aria-live="polite" aria-label="Historial de chat"></section>
    <div class="status" id="status">Listo.</div>

    <form id="form" class="input">
      <textarea id="q" placeholder="Ej.: ¿Qué horario de check-in recomiendan?" required></textarea>
      <button id="send" type="submit" title="Enviar (Enter)">Enviar</button>
    </form>
  </div>

  <script>
    const API_URL = "https://vercel-proxy-ask.vercel.app/api/ask"; // ← tu proxy Vercel

    const $ = sel => document.querySelector(sel);
    const chat = $("#chat");
    const form = $("#form");
    const input = $("#q");
    const btn = $("#send");
    const statusEl = $("#status");

    function timeNow() {
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function addMessage({ text, role }) {
      const el = document.createElement("div");
      el.className = `msg ${role}`;
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = role === "user" ? "Tú" : "AI";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      const t = document.createElement("span");
      t.className = "time";
      t.textContent = timeNow();
      bubble.appendChild(t);
      el.appendChild(avatar);
      el.appendChild(bubble);
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }
    function setStatus(msg) { statusEl.textContent = msg; }

    function showThinking(targetBubble) {
      const placeholder = document.createElement("span");
      let dots = 0;
      const id = setInterval(() => { dots = (dots + 1) % 4; placeholder.textContent = " " + ".".repeat(dots); }, 400);
      targetBubble.appendChild(placeholder);
      return () => { clearInterval(id); placeholder.remove(); };
    }

    async function askAPI(question) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}` + (txt ? ` – ${txt.slice(0,200)}` : ""));
      }
      const data = await res.json();
      return typeof data.answer === "string" ? data.answer : JSON.stringify(data, null, 2);
    }

    addMessage({ role: "bot", text: "Hola, soy tu asistente de check-in. Pregúntame horarios, recomendaciones y dudas generales." });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); form.requestSubmit(); }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;

      addMessage({ role:"user", text: question });

      const respBubble = addMessage({ role:"bot", text: "Pensando" });
      const stopSpin = showThinking(respBubble);

      btn.disabled = true;
      input.value = "";
      input.style.height = "52px";
      setStatus("Consultando…");

      try {
        const answer = await askAPI(question);
        respBubble.childNodes[0].textContent = answer;
        setStatus("Listo.");
      } catch (err) {
        respBubble.childNodes[0].textContent = "Ocurrió un error al consultar el servicio.\n\nDetalle: " + (err?.message || String(err));
        respBubble.style.borderColor = "rgba(239,68,68,.35)";
      } finally {
        stopSpin();
        btn.disabled = false;
        chat.scrollTop = chat.scrollHeight;
        input.focus();
      }
    });

    function autoResize() {
      this.style.height = "52px";
      this.style.height = (this.scrollHeight > 52 ? this.scrollHeight : 52) + "px";
      chat.scrollTop = chat.scrollHeight;
    }
    input.addEventListener("input", autoResize);
  </script>
</body>
</html>
